# 首次搞昇腾环境

# 2024-04-30 Lighthawk



### 也不算首次，这次顺利些

##### 0、先搭建环境，安装 toolkit
```shell
# OS 依赖安装：
# https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/80RC2alpha001/softwareinst/instg/instg_0030.html
yum install -y gcc gcc-c++ make cmake unzip zlib-devel libffi-devel openssl-devel pciutils net-tools sqlite-devel lapack-devel gcc-gfortran python3-devel

# python 依赖安装：
pip3 install attrs
pip3 install numpy
pip3 install decorator
pip3 install sympy
pip3 install cffi
pip3 install pyyaml
pip3 install pathlib2
pip3 install psutil
pip3 install protobuf
pip3 install scipy
pip3 install requests
pip3 install absl-py

# 目前只装了 toolkit，装好依赖后直接 --install，期间选择是否 EULA，选 Y
./Ascend-cann-toolkit_8.0.RC1.alpha003_linux-x86_64.run --install

# 配置环境变量，仅仅第一行似乎不行，遂将 set_env.sh 里全贴进到了 /etc/profile;
# source /usr/local/Ascend/ascend-toolkit/set_env.sh
export ASCEND_TOOLKIT_HOME=/usr/local/Ascend/ascend-toolkit/latest
export LD_LIBRARY_PATH=${ASCEND_TOOLKIT_HOME}/lib64:${ASCEND_TOOLKIT_HOME}/lib64/plugin/opskernel:${ASCEND_TOOLKIT_HOME}/lib64/plugin/nnengine:${ASCEND_TOOLKIT_HOME}/opp/built-in/op_impl/ai_core/tbe/op_tiling/lib/linux/$(arch):$LD_LIBRARY_PATH
export LD_LIBRARY_PATH=${ASCEND_TOOLKIT_HOME}/tools/aml/lib64:${ASCEND_TOOLKIT_HOME}/tools/aml/lib64/plugin:$LD_LIBRARY_PATH
export PYTHONPATH=${ASCEND_TOOLKIT_HOME}/python/site-packages:${ASCEND_TOOLKIT_HOME}/opp/built-in/op_impl/ai_core/tbe:$PYTHONPATH
export PATH=${ASCEND_TOOLKIT_HOME}/bin:${ASCEND_TOOLKIT_HOME}/compiler/ccec_compiler/bin:${ASCEND_TOOLKIT_HOME}/tools/ccec_compiler/bin:$PATH
export ASCEND_AICPU_PATH=${ASCEND_TOOLKIT_HOME}
export ASCEND_OPP_PATH=${ASCEND_TOOLKIT_HOME}/opp
export TOOLCHAIN_HOME=${ASCEND_TOOLKIT_HOME}/toolkit
export ASCEND_HOME_PATH=${ASCEND_TOOLKIT_HOME}

# 再尝试运行 atc，提示缺少 libascend_hal.so
# 通过：https://bbs.huaweicloud.com/blogs/344623 解决库缺失的问题
vim /etc/ld.so.conf
# 添加 libascend_hal.so，再操作：
ldconfig
```

##### 1、先下代码仓，gitee 的 samples
```shell
# 代码仓：https://gitee.com/ascend/samples
# 快速入门：https://www.hiascend.com/document/detail/zh/canncommercial/80RC1/developmentguide/opdevg/Ascendcopdevg/atlas_ascendc_10_0006.html
# 从快速入门里，找到了初次调测用的代码路径：operator/AddCustomSample/KernelLaunch/AddKernelInvocation
# 这个目录下的 demo，是入门教程视频中的样例

# 尝试编译运行：
# 失败版本（缺失很多东西）：
mkdir build
cd build
cmake ../ && make -j 8

# 成功版本（就在该目录下执行 run.sh）：
# bash run.sh -r [RUN_MODE] -v [SOC_VERSION]
bash run.sh -v ascend310p -r cpu

# 编译后产生可执行文件 ./add_cpu，但运行时也踩坑了。如下是没问题的：
export PRINT_TIK_MEM_ACCESS=FALSE && ./add_cpu

# 这样的环境和cpu调测基本搞好了，仅搭建环境就有些费脑...
# 其实，这也可以用来调测/验证和考试了...
# 不要偷懒哦（上次考试学习的昇腾入门级知识已经忘记了，艹）
# 附代码全路径：/home/workspace/code/ascend/samples/operator/AddCustomSample/KernelLaunch/AddKernelInvocation
```